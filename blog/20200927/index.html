<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.25.0" theme-name="Stellar" theme-version="1.25.0"><meta name="generator" content="Hexo 7.0.0"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin><link rel="preconnect" href="https://unpkg.com" crossorigin><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#f8f8f8"><title>心率管家的设计与开发（下篇：信号处理） - XAOXUU</title><meta name="description" content="作为一名开发者，如何使用手机摄像头测量心率呢？在心率管家默默无闻地上线了一年多之后，现在终于打算来好好聊聊关于手机摄像头测量心率的那些事。本文参考了很多前辈的文章，将在文末列出。"><meta property="og:type" content="article"><meta property="og:title" content="心率管家的设计与开发（下篇：信号处理）"><meta property="og:url" content="https://xaoxuu.com/blog/20200927/"><meta property="og:site_name" content="XAOXUU"><meta property="og:description" content="作为一名开发者，如何使用手机摄像头测量心率呢？在心率管家默默无闻地上线了一年多之后，现在终于打算来好好聊聊关于手机摄像头测量心率的那些事。本文参考了很多前辈的文章，将在文末列出。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://xaoxuu.com/assets/xaoxuu/blog/2020-0927b@2x.jpg"><meta property="og:image" content="https://xaoxuu.com/assets/xaoxuu/blog/2020-0927c@1x.svg"><meta property="og:image" content="https://xaoxuu.com/assets/xaoxuu/blog/2020-0927d@1x.svg"><meta property="og:image" content="https://xaoxuu.com/assets/xaoxuu/blog/2020-0927e@2x.jpg"><meta property="og:image" content="https://xaoxuu.com/assets/xaoxuu/blog/2020-0927f@2x.jpg"><meta property="article:published_time" content="2020-09-27T00:00:00.000Z"><meta property="article:modified_time" content="2020-09-27T00:00:00.000Z"><meta property="article:author" content="xaoxuu"><meta property="article:tag" content="iOS"><meta property="article:tag" content="Swift"><meta property="article:tag" content="心率"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://xaoxuu.com/assets/xaoxuu/blog/2020-0927b@2x.jpg"><meta name="keywords" content="iOS,Swift,心率"><link rel="alternate" href="/atom.xml" title="XAOXUU" type="application/atom+xml"><link rel="stylesheet" href="/css/main.css"><link rel="apple-touch-icon" sizes="180x180" href="/assets/xaoxuu/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/xaoxuu/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/xaoxuu/favicon/favicon-16x16.png"><link rel="manifest" href="/assets/xaoxuu/favicon/site.webmanifest"><link rel="shortcut icon" href="/assets/xaoxuu/favicon/favicon.ico"><meta name="theme-color" content="#f8f8f8"><link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/lxgwwenkaiscreen.css" media="all"></head><body><div class="l_cover post"><div class="cover"><div class="lazy img bg" data-bg="/assets/xaoxuu/blog/2019-0723b@2x.webp"></div></div></div><div class="l_body content" id="start" layout="page.layout"><aside class="l_left"><img no-lazy class="sidebar-bg" src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.13/image/sidebar-bg1@small.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"><div class="sidebar-container blur"><header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp)"></div><img no-lazy class="avatar" src="/assets/xaoxuu/avatar/rect-256@2x.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">XAOXUU</div><div class="sub normal cap">风暴前夕</div><div class="sub hover cap" style="opacity:0">xaoxuu.com</div></a></div></header><div class="nav-area"><div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" class="icon search-icon" viewbox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"/><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"/></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div><nav class="menu dis-select"><a class="nav-item active" title="博客" href="/"><img no-lazy src="/assets/icons/sf/blog-cyan.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="nav-item" title="项目" href="/wiki/"><img no-lazy src="/assets/icons/sf/wiki-green.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="nav-item" title="探索" href="/notes/"><img no-lazy src="/assets/icons/sf/explore-amber.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="nav-item" title="社交" href="/friends/"><img no-lazy src="/assets/icons/sf/social-red.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a></nav></div><div class="widgets"><widget class="widget-wrapper toc single" id="data-toc" collapse="false"><div class="widget-header cap dis-select"><span class="name">本文目录</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%89%E7%94%B5%E5%AE%B9%E7%A7%AF%E8%84%89%E6%90%8F%E6%B3%A2%E6%8F%8F%E8%AE%B0%E6%B3%95"><span class="toc-text">光电容积脉搏波描记法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86"><span class="toc-text">信号处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%89%E5%86%B2%E6%8E%A2%E6%B5%8B%E5%99%A8"><span class="toc-text">脉冲探测器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E8%84%89%E7%8E%87"><span class="toc-text">计算脉率</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E7%A1%AE%E6%80%A7%E4%B8%8E%E5%8F%82%E8%80%83%E4%BB%B7%E5%80%BC"><span class="toc-text">准确性与参考价值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%89%E7%8E%87%E5%92%8C%E5%BF%83%E7%8E%87"><span class="toc-text">脉率和心率</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-text">后记</span></a></li></ol></div></div></widget><widget class="widget-wrapper post-list"><div class="widget-header cap dis-select"><span class="name">最近更新</span><a class="cap-action" id="rss" title="Subscribe" href="/atom.xml"><svg class="icon" viewbox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8938"><path d="M800.966 947.251c0-404.522-320.872-732.448-716.69-732.448V62.785c477.972 0 865.44 395.987 865.44 884.466h-148.75z m-162.273 0h-148.74c0-228.98-181.628-414.598-405.678-414.598v-152.01c306.205 0 554.418 253.68 554.418 566.608z m-446.24-221.12c59.748 0 108.189 49.503 108.189 110.557 0 61.063-48.44 110.563-108.188 110.563-59.747 0-108.18-49.5-108.18-110.563 0-61.054 48.433-110.556 108.18-110.556z" p-id="8939"/></svg></a></div><div class="widget-body fs14"><a class="item title" href="/blog/20240111/"><span class="title">项目警告对构建速度的巨大影响</span></a><a class="item title" href="/blog/20240110/"><span class="title">关于 ObjC 通知的一个神奇崩溃</span></a><a class="item title" href="/blog/20231223/"><span class="title">Gallery 标签组件的使用方法和 Unsplash 高清壁纸分享</span></a><a class="item title" href="/blog/20231213/"><span class="title">苹果设计素材官方下载地址</span></a><a class="item title" href="/blog/20221217/"><span class="title">博客入门：每个人的独立博客</span></a><a class="item title" href="/blog/20221126/"><span class="title">博客进阶：自动化部署</span></a><a class="item title" href="/blog/20221121/"><span class="title">GitHub Codespaces 快速体验</span></a><a class="item title" href="/blog/20201119/"><span class="title">苹果设计开发加速器线上活动</span></a><a class="item title" href="/blog/20210102/"><span class="title">用 GitHub 搭建一个简单的脚本库</span></a><a class="item title active" href="/blog/20200927/"><span class="title">心率管家的设计与开发（下篇：信号处理）</span><svg t="1705415018387" class="icon" viewbox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14793" width="200" height="200"><path d="M256 896a42.666667 42.666667 0 0 1-20.906667-5.546667A42.666667 42.666667 0 0 1 213.333333 853.333333V227.413333A97.28 97.28 0 0 1 307.2 128h409.6A97.28 97.28 0 0 1 810.666667 227.413333V853.333333a42.666667 42.666667 0 0 1-21.333334 36.693334 42.666667 42.666667 0 0 1-42.666666 0l-241.92-136.96-227.413334 136.533333A42.666667 42.666667 0 0 1 256 896z" p-id="14794"/></svg></a></div></widget></div><footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/xaoxuu" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/social/08a41b181ce68.svg"></a><a class="social" href="https://music.163.com/#/user/home?id=63035382" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/social/3845874.svg"></a><a class="social" href="https://unsplash.com/@xaoxuu" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/social/3616429.svg"></a><a class="social" href="/about/#comments" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/placeholder/social/942ebbf1a4b91.svg"></a></div></footer></div></aside><div class="l_main" id="main"><div class="bread-nav fs12"><div class="left"><div id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/blog/categories/%E8%AE%BE%E8%AE%A1%E5%BC%80%E5%8F%91/">设计开发</a></div><div id="post-meta"><span class="author">本文由 <a href="/author/xaoxuu/">xaoxuu</a> 发布于</span> <span class="created"><time datetime="2020-09-27T00:00:00.000Z">2020年9月27日</time></span> <span class="updated">，更新于&nbsp;<time datetime="2020-09-27T00:00:00.000Z">2020年9月27日</time></span></div></div></div><article class="md-text content post"><h1 class="article-title"><span>心率管家的设计与开发（下篇：信号处理）</span></h1><p>作为一名开发者，如何使用手机摄像头测量心率呢？在心率管家默默无闻地上线了一年多之后，现在终于打算来好好聊聊关于手机摄像头测量心率的那些事。本文参考了很多前辈的文章，将在文末列出。</p><span id="more"></span><div class="tag-plugin video-wrap"><div class="frame-wrap" id="iphone11" focus="top"><video poster="/assets/wiki/heartmate/docs/usage01.jpg" playsinline muted loop autoplay preload="metadata"><source src="/assets/wiki/heartmate/docs/usage01.mp4" type="video/mp4"></video><div class="frame"></div></div></div><h2 id="光电容积脉搏波描记法"><a href="#光电容积脉搏波描记法" class="headerlink" title="光电容积脉搏波描记法"></a>光电容积脉搏波描记法</h2><p>目前市面上大部分便携心率检测设备都是基于光电容积脉搏波描记法来测量的。由于心跳引起动脉周期性变化，动脉内血液的容积发生周期性变化，因而对光线的吸收也会呈现同样的周期性变化，这个周期性变化的频率就是脉率，脉率大部分情况都和心率一致。</p><p>打开相机，把手指指尖覆盖在摄像头上，观察屏幕上的取景框，就可以发现每心跳一次，屏幕中的红色都会变暗一次。对每一帧画面提取 RGB 均值，并转换到 HSV 色彩空间，把色相 H 作为特征值，得到时域信号。</p><h2 id="信号处理"><a href="#信号处理" class="headerlink" title="信号处理"></a>信号处理</h2><p>我使用简单的时域分析法计算脉率，关键点就是计算采样时间内的波峰个数。把色相信号绘制波形图如下：</p><div class="tag-plugin image"><div class="image-bg" style="background:#fff;padding:8px"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/xaoxuu/blog/2020-0927b@2x.jpg" style="width:300px"></div></div><p>由于覆盖力度不稳定导致色相会整体偏移因而产生低频噪声，再加原本就存在的高频噪声影响，波形显得很杂乱无章，所以使用带通递归滤波器进行滤波：</p><div class="tag-plugin image"><div class="image-bg" style="background:#fff;padding:16px"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/xaoxuu/blog/2020-0927c@1x.svg"></div></div><p>公式展开为：</p><div class="tag-plugin image"><div class="image-bg" style="background:#fff;padding:16px"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/xaoxuu/blog/2020-0927d@1x.svg"></div></div><p>用 Swift 语言实现这个滤波器的算法（10阶）为：</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">struct</span> <span class="title class_">BandpassFilter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> x <span class="operator">=</span> [<span class="type">CGFloat</span>].<span class="keyword">init</span>(repeating: <span class="number">0</span>, count: <span class="number">11</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> y <span class="operator">=</span> [<span class="type">CGFloat</span>].<span class="keyword">init</span>(repeating: <span class="number">0</span>, count: <span class="number">11</span>)</span><br><span class="line">    <span class="keyword">@discardableResult</span> <span class="keyword">mutating</span> <span class="keyword">func</span> <span class="title function_">filted</span>(<span class="keyword">_</span> <span class="params">value</span>: <span class="type">CGFloat</span>) -&gt; <span class="type">CGFloat</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> x.count <span class="operator">&gt;</span> <span class="number">10</span>, y.count <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> <span class="operator">..&lt;</span> <span class="number">10</span> &#123;</span><br><span class="line">            x[i] <span class="operator">=</span> x[i<span class="operator">+</span><span class="number">1</span>]</span><br><span class="line">            y[i] <span class="operator">=</span> y[i<span class="operator">+</span><span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        x[<span class="number">10</span>] <span class="operator">=</span> value <span class="operator">/</span> <span class="number">1.894427025e+01</span></span><br><span class="line">        y[<span class="number">10</span>] <span class="operator">=</span> x[<span class="number">10</span>] <span class="operator">-</span> x[<span class="number">0</span>] <span class="operator">+</span> <span class="number">5</span> <span class="operator">*</span> (x[<span class="number">2</span>] <span class="operator">-</span> x[<span class="number">8</span>]) <span class="operator">+</span> <span class="number">10</span> <span class="operator">*</span> (x[<span class="number">6</span>] <span class="operator">-</span> x[<span class="number">4</span>])</span><br><span class="line">        y[<span class="number">10</span>] <span class="operator">+=</span> (<span class="operator">-</span><span class="number">0.0000000000</span> <span class="operator">*</span> y[<span class="number">0</span>]) <span class="operator">+</span> (<span class="number">0.0357796363</span> <span class="operator">*</span> y[<span class="number">1</span>])</span><br><span class="line">        y[<span class="number">10</span>] <span class="operator">+=</span> (<span class="operator">-</span><span class="number">0.1476158522</span> <span class="operator">*</span> y[<span class="number">2</span>]) <span class="operator">+</span> (<span class="number">0.3992561394</span> <span class="operator">*</span> y[<span class="number">3</span>])</span><br><span class="line">        y[<span class="number">10</span>] <span class="operator">+=</span> (<span class="operator">-</span><span class="number">1.1743136181</span> <span class="operator">*</span> y[<span class="number">4</span>]) <span class="operator">+</span> (<span class="number">2.4692165842</span> <span class="operator">*</span> y[<span class="number">5</span>])</span><br><span class="line">        y[<span class="number">10</span>] <span class="operator">+=</span> (<span class="operator">-</span><span class="number">3.3820859632</span> <span class="operator">*</span> y[<span class="number">6</span>]) <span class="operator">+</span> (<span class="number">3.9628972812</span> <span class="operator">*</span> y[<span class="number">7</span>])</span><br><span class="line">        y[<span class="number">10</span>] <span class="operator">+=</span> (<span class="operator">-</span><span class="number">4.3832594900</span> <span class="operator">*</span> y[<span class="number">8</span>]) <span class="operator">+</span> (<span class="number">3.2101976096</span> <span class="operator">*</span> y[<span class="number">9</span>])</span><br><span class="line">        <span class="keyword">return</span> y[<span class="number">10</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这个算法是从 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/WuXiaoTu/HeartRate">WuXiaoTu&#x2F;HeartRate</a> 这个开源库中翻译来的。</p></blockquote><p>经过滤波之后就能看到波形图呈现锯齿状，由于这是由摄像头捕捉到的色相的波形图，所以看起来并不会像心电图那样：</p><div class="tag-plugin image"><div class="image-bg" style="background:#fff;padding:8px"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/xaoxuu/blog/2020-0927e@2x.jpg" style="width:300px"></div></div><p>有了干净的波形图，就可以数出一段时间内的波峰个数，从而计算出频率。例如数5秒内有多少个波峰，然后乘以12就是每分钟脉搏跳动次数，也就是这5秒内的平均脉率。现在 GitHub 上的很多同类的开源项目也都是这种方案。由于连续测量的时间越长，发生中断的可能性就越大，测量成功率就越低，再考虑到心率本身就是变化的，时间跨度太长也会使得数据变得没有意义，测量时间太短又很容易被个别误差数据影响。</p><p>网络上现有方案都是先确定测量时长，时间结束后计算结果：</p><ul><li>如果测量时间短：成功率高，准确性低。</li><li>如果测量时间中等：成功率低，准确性高。</li><li>如果测量时间长：成功率很低，准确性很高，但是数据意义不大。</li></ul><p>我想出了一种新的方案，就是每探测到一个有效脉冲，就记录下这个脉冲与上一个有效脉冲之间的间隔，两个连续的有效脉冲计算出来的频率就是100%正确的瞬时脉率。所以改进后的方案是：开始测量后，始终记录脉冲，随时可以计算瞬时脉率、最后若干秒的平均脉率。</p><ul><li>成功率：100%（不存在测量中断而失败的情况）</li><li>准确性的情况如下：<ul><li>如果脉冲计数都是由脉搏跳动引起的，测量结果就是完全准确的</li><li>如果脉搏跳动了而脉冲计数没有增加，不会影响结果，因为计算时只会把有效脉冲的周期进行累加</li><li>如果在脉搏跳动间隙额外增加了脉冲计数，那么数据就会失真</li></ul></li></ul><p>如果不故意快速抖动手指，数据失真的情况就不会发生，因为手指不离开摄像头并在两次脉搏跳动中间产生一次色相饱和度明度都以假乱真的脉冲信号是很难的。</p><h3 id="脉冲探测器"><a href="#脉冲探测器" class="headerlink" title="脉冲探测器"></a>脉冲探测器</h3><p>经过滤波后的数值是围绕0上下波动的，分别记录大于0的值和小于0的值，各自保存到数组中，然后求出它们的平均值：</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> filted <span class="operator">&gt;</span> <span class="number">0</span> &#123;</span><br><span class="line">    upVals.append(filted)</span><br><span class="line">    <span class="keyword">if</span> upVals.count <span class="operator">&gt;</span> <span class="number">20</span> &#123;</span><br><span class="line">        upVals.removeFirst(upVals.count <span class="operator">-</span> <span class="number">20</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> filted <span class="operator">&lt;</span> <span class="number">0</span> &#123;</span><br><span class="line">    downVals.append(filted)</span><br><span class="line">    <span class="keyword">if</span> downVals.count <span class="operator">&gt;</span> <span class="number">20</span> &#123;</span><br><span class="line">        downVals.removeFirst(downVals.count <span class="operator">-</span> <span class="number">20</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> avgUp <span class="operator">=</span> upVals.reduce(<span class="number">0</span>, <span class="operator">+</span>) <span class="operator">/</span> <span class="type">CGFloat</span>(upVals.count)</span><br><span class="line"><span class="keyword">let</span> avgDown <span class="operator">=</span> downVals.reduce(<span class="number">0</span>, <span class="operator">+</span>) <span class="operator">/</span> <span class="type">CGFloat</span>(downVals.count)</span><br></pre></td></tr></table></figure><p>如果新的值高于 <code>avgUp</code> 的一半，就标记 <code>flag = true</code> ，低于 <code>avgDown</code> 的一半且 <code>flag = true</code> 就标记 <code>flag = true</code>，触发一次脉冲，记录下这个脉冲的时间戳。如果两个脉冲之间的时间间隔符合正常心率的范围，就认为是有效脉冲。</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> filted <span class="operator">&gt;</span> <span class="number">0.5</span> <span class="operator">*</span> avgUp  &#123;</span><br><span class="line">    flag <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> filted <span class="operator">&lt;</span> <span class="number">0.5</span> <span class="operator">*</span> avgDown <span class="operator">&amp;&amp;</span> flag <span class="operator">==</span> <span class="literal">true</span> &#123;</span><br><span class="line">    flag <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">let</span> time <span class="operator">=</span> <span class="type">CACurrentMediaTime</span>()</span><br><span class="line">    <span class="keyword">let</span> period <span class="operator">=</span> time <span class="operator">-</span> periodStart</span><br><span class="line">    <span class="comment">// 与上一个周期间隔时间满足正常周期范围</span></span><br><span class="line">    <span class="keyword">if</span> period <span class="operator">&lt;</span> <span class="type">MAX_PERIOD</span> <span class="operator">&amp;&amp;</span> period <span class="operator">&gt;</span> <span class="type">MIN_PERIOD</span> &#123;</span><br><span class="line">        <span class="comment">// 记录这次脉冲与上次脉冲的时间间隔</span></span><br><span class="line">        periods.append(period)</span><br><span class="line">        <span class="comment">// 捕获到脉冲</span></span><br><span class="line">        delegate<span class="operator">?</span>.pulseDetector(detector: <span class="keyword">self</span>, capture: periods)</span><br><span class="line">    &#125;</span><br><span class="line">    periodStart <span class="operator">=</span> time</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> filted</span><br></pre></td></tr></table></figure><p>上文「正常心率的范围」如何界定？心率如果低到 40bpm 此时周期达到最大值，如果心率高达 255bpm 则周期达到最小值。</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="type">MAX_PERIOD</span> <span class="operator">=</span> <span class="type">CFTimeInterval</span>(<span class="number">60.0</span> <span class="operator">/</span> <span class="number">40</span>)</span><br><span class="line"><span class="type">MIN_PERIOD</span> <span class="operator">=</span> <span class="type">CFTimeInterval</span>(<span class="number">60.0</span> <span class="operator">/</span> <span class="number">255</span>)</span><br></pre></td></tr></table></figure><h3 id="计算脉率"><a href="#计算脉率" class="headerlink" title="计算脉率"></a>计算脉率</h3><p>上一步记录下了每个脉冲的周期，取出最后 N 个要计算的脉冲，把它们的周期相加就是总时长，用 <code>个数 / 时长</code> 计算的值就是频率，频率乘以 <code>60</code> 就是每分钟的脉冲数，也就是脉率。</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">calcFrequency</span>(<span class="params">count</span>: <span class="type">Int</span>) -&gt; <span class="type">CGFloat</span>? &#123;</span><br><span class="line">    <span class="keyword">guard</span> (<span class="number">0</span> <span class="operator">...</span> periods.count).contains(count) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> duration <span class="operator">=</span> periods.dropFirst(periods.count <span class="operator">-</span> count).reduce(<span class="number">0</span>, <span class="operator">+</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="type">CGFloat</span>(count) <span class="operator">/</span> <span class="type">CGFloat</span>(duration)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="tag-plugin img-wrap"><div class="frame-wrap" id="iphone11"><img class="img lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/xaoxuu/blog/2020-0927f@2x.jpg"><div class="frame"></div></div></div><h2 id="准确性与参考价值"><a href="#准确性与参考价值" class="headerlink" title="准确性与参考价值"></a>准确性与参考价值</h2><p>由于心率是动态变化的，即使测量的脉搏跳动都是准确的，也就是说测量阶段实现了零误差，但是计算方式不一样也会产生不同的结果。因此直接拿结果去和小米手环或者 Apple Watch 上显示的数值去进行对比是不严谨的。正确地方法是在一个时间段内用多种方式测量的同时亲自用手测量脉搏跳动次数，可以借助本文的 demo 计算瞬时或者平均脉率，如果一段时间的脉冲计数完全正确，那么 demo 计算的结果就是完全准确的，瞬时脉率、最后 N 秒的平均脉率一般都不会相同。因此即使戴在一只手上同一时间进行测量，不同产品显示的心率不同也并不能说明它们谁更准，只能说谁的结果更具有参考价值。</p><p>对此，我优化后的心率管家测量方案可以选择测量时长，也可以随时结束测量，运动后心率变化快的时候适合取短时间内例如5s平均脉率，心平气和的时候可以取适当长一点的例如10s或者20s的平均脉率。</p><h2 id="脉率和心率"><a href="#脉率和心率" class="headerlink" title="脉率和心率"></a>脉率和心率</h2><p>脉率是每分钟脉搏的次数，心率是每分钟心跳次数，健康情况下脉率与心率一致，但是如果出现心律失常，心脏有一些跳动不能有效将血液泵至全身，因此会出现脉搏缺失，导致脉率显著低于心率。如果用来判断心脏功能状态，误差很大。对于心动过速、低血压症和休克病人，即使是心率规则，由于脉压差很小，脉搏也会很弱，此时往往不能够准确测量脉率。</p><p>另外，脉搏随肢体移动会形成伪迹波动，也会影响脉率的测量。而心率不受心律失常、心动过速、休克、肢体活动的影响，所以在临床上，医生判断心跳活动不是看脉率，而是看心率，摸脉搏只是一个辅助操作。</p><p>因此，通过手环、手表、app 测量的“心率”并不是一个完全可靠的数据。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>非常感谢 @JustinYang 大佬在滤波算法方面给予的援助。也十分感谢 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://punmy.cn/">@Punmy</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/WuXiaoTu">@WuXiaoTu</a> 等作者的文章，使得后人能够少走很多弯路。</p><div class="tag-plugin link dis-select"><a class="link-card rich" href="https://xaoxuu.com/blog/20190723/" target="_blank" rel="external nofollow noopener noreferrer" cardlink autofill="title,icon,desc"><div class="top"><div class="lazy img" data-bg="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/link/8f277b4ee0ecd.svg"></div><span class="cap link fs12">https://xaoxuu.com/blog/20190723/</span></div><div class="bottom"><span class="title">https://xaoxuu.com/blog/20190723/</span><span class="cap desc fs12"></span></div></a></div><div class="article-footer reveal fs14"><section id="references"><div class="header"><span>参考资料</span></div><div class="body"><ul><li class="post-title"><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://punmy.cn/2016/07/28/15231176397746.html">心跳之旅—💗—iOS用手机摄像头检测心率(PPG)</a></p></li><li class="post-title"><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.jianshu.com/p/695c131abfa5">PPG光电容积脉搏波描记法技术概况</a></p></li><li class="post-title"><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/shengzhadon/article/details/46803401">数字信号处理公式变程序（四）——巴特沃斯滤波器（下）</a></p></li><li class="post-title"><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.jianshu.com/p/9f678e0bdf9b">iOS手机摄像头测心率</a></p></li><li class="post-title"><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.zhihu.com/question/27391584">各种智能手表&#x2F;智能手环的心率监测功能精准度怎么样？都有哪些技术在里面？</a></p></li><li class="post-title"><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/WuXiaoTu/HeartRate">通过手机摄像头获取心率值</a></p></li><li class="post-title"><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.latexlive.com/">LaTeX公式编辑器</a></p></li></ul></div></section><section id="license"><div class="header"><span>许可协议</span></div><div class="body"><p>本文为 <a href="https://xaoxuu.com/">xaoxuu</a> 原创，采用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p></div></section><section id="share"><div class="header"><span>分享文章</span></div><div class="body"><div class="link"><input class="copy-area" readonly id="copy-link" value="https://xaoxuu.com/blog/20200927/"></div><div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot)"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg"></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://xaoxuu.com/blog/20200927/&title=心率管家的设计与开发（下篇：信号处理） - XAOXUU&pics=/assets/xaoxuu/blog/2019-0723a@2x.webp&summary=作为一名开发者，如何使用手机摄像头测量心率呢？在心率管家默默无闻地上线了一年多之后，现在终于打算来好好聊聊关于手机摄像头测量心率的那些事。本文参考了很多前辈的文章，将在文末列出。"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg"></a><a class="social share-item email" href="mailto:?subject=心率管家的设计与开发（下篇：信号处理） - XAOXUU&amp;body=https://xaoxuu.com/blog/20200927/"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg"></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;复制成功&quot;)"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg"></a></div><div class="qrcode" id="qrcode-wechat" style="visibility:hidden;height:0"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://xaoxuu.com/blog/20200927/"></div></div></section></div></article><div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/blog/20201119/">苹果设计开发加速器线上活动</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/blog/20200823/">静态博客使用 Issues API 来实现动态发布友链、书签</a></div></section></div><div class="related-wrap md-text reveal" id="comments"><section class="header cmt-title cap theme">快来参与讨论吧</section><section class="body cmt-body giscus"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden" viewbox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"/></svg><div id="giscus" src="https://giscus.xaox.cc/client.js" data-repo="xaoxuu/blog-comments" data-repo-id="MDEwOlJlcG9zaXRvcnkzMzM0MzA0NzE=" data-category="Announcements" data-category-id="DIC_kwDOE9--x84CTUHq" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div></section></div><footer class="page-footer reveal fs12"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs14">博客</span><a href="/">近期发布</a><a href="/blog/hot/">热门文章</a><a href="/blog/categories/">分类</a><a href="/blog/tags/">标签</a><a href="/blog/archives/">归档</a></div><div class="sitemap-group"><span class="fs14">项目</span><a href="/wiki/tags/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/">开源项目</a><a href="/wiki/tags/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">实用工具</a><a href="/wiki/tags/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/">应用程序</a><a href="/wiki/tags/%E7%9F%A5%E8%AF%86%E5%BA%93/">知识库</a></div><div class="sitemap-group"><span class="fs14">社交</span><a target="_blank" rel="external nofollow noopener noreferrer" href="https://inkss.cn">枋柚梓</a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.mhuig.top">MHuiG</a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://colsrch.cn">Colsrch</a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://dusays.com">杜老师说</a><a href="/friends/">更多友链</a></div><div class="sitemap-group"><span class="fs14">关于</span><a href="/about/">本站简介</a><a href="/privacy/">隐私政策</a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/xaoxuu">GitHub</a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://git.xaox.cc/xaoxuu">Gitea</a></div></div><div class="text"><p><span class="jinrishici-sentence"></span>本站由 <a href="/">xaoxuu</a> 使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.25.0">Stellar 1.25.0</a> 主题创建。</p><script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script></div></footer><div class="float-panel mobile-only blur" style="display:none"><button type="button" class="sidebar-toggle mobile" onclick="sidebar.toggle()"><svg t="1705412886951" class="icon" viewbox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8331" width="200" height="200"><path d="M638.72 970.666667h-256c-118.186667 0-198.272-25.002667-251.946667-78.72S52.053333 758.186667 52.053333 640V384c0-118.186667 25.002667-198.272 78.72-251.946667S264.533333 53.333333 382.72 53.333333h256c118.186667 0 198.272 25.002667 251.946667 78.72S969.386667 265.813333 969.386667 384v256c0 118.186667-25.002667 198.272-78.72 251.946667S756.906667 970.666667 638.72 970.666667z m-256-853.333334c-100.096 0-165.802667 19.2-206.72 59.946667S116.053333 283.904 116.053333 384v256c0 100.096 19.072 165.802667 59.946667 206.72S282.624 906.666667 382.72 906.666667h256c100.096 0 165.802667-19.072 206.72-59.946667S905.386667 740.096 905.386667 640V384c0-100.096-19.072-165.802667-59.946667-206.72S738.816 117.333333 638.72 117.333333z" p-id="8332"/><path d="M638.72 970.666667a32 32 0 0 1-32-32V85.333333a32 32 0 0 1 32-32 32 32 0 0 1 32 32v853.333334a32 32 0 0 1-32 32zM340.053333 653.226667a31.914667 31.914667 0 0 1-22.613333-9.386667 32 32 0 0 1 0-45.269333L404.053333 512 317.44 425.386667a32 32 0 0 1 0-45.226667 32 32 0 0 1 45.226667 0l109.226666 109.226667a32 32 0 0 1 0 45.269333L362.666667 643.84a31.914667 31.914667 0 0 1-22.613334 9.386667z" p-id="8333"/></svg></button></div><div class="main-mask" onclick="sidebar.toggle()"></div></div></div><div class="scripts"><script type="text/javascript">const stellar={loadCSS:(e,s,t,n)=>{var i,l=window.document,a=l.createElement("link");if(s)i=s;else{var r=(l.body||l.getElementsByTagName("head")[0]).childNodes;i=r[r.length-1]}var o=l.styleSheets;if(n)for(var c in n)n.hasOwnProperty(c)&&a.setAttribute(c,n[c]);a.rel="stylesheet",a.href=e,a.media="only x",function e(s){if(l.body)return s();setTimeout((function(){e(s)}))}((function(){i.parentNode.insertBefore(a,s?i:i.nextSibling)}));var d=function(e){for(var s=a.href,t=o.length;t--;)if(o[t].href===s)return e();setTimeout((function(){d(e)}))};function p(){a.addEventListener&&a.removeEventListener("load",p),a.media=t||"all"}return a.addEventListener&&a.addEventListener("load",p),a.onloadcssdefined=d,d(p),a},loadScript:(e,s)=>new Promise((t,n)=>{var i=document.createElement("script");if(e.startsWith("/")&&(e=stellar.config.root+e.substring(1)),i.src=e,s)for(let e of Object.keys(s))i[e]=s[e];else i.async=!0;i.onerror=n,i.onload=i.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(i.onload=i.onreadystatechange=null,t())},document.head.appendChild(i)}),jQuery:e=>{"undefined"==typeof jQuery?stellar.loadScript(stellar.plugins.jQuery).then(e):e()},version:"1.25.0",github:"https://github.com/xaoxuu/hexo-theme-stellar/tree/1.25.0",config:{date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},root:"/"},plugins:{jQuery:"https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js"},search:{}};if(stellar.search.service="local_search","local_search"==stellar.search.service){let e=Object.assign({},{field:"all",path:"/search.json",content:!0,sort:"-date"});stellar.search[stellar.search.service]=e}stellar.plugins.stellar=Object.assign({sites:"/js/plugins/sites.js",friends:"/js/plugins/friends.js",ghinfo:"/js/plugins/ghinfo.js",timeline:"/js/plugins/timeline.js",linkcard:"/js/plugins/linkcard.js",fcircle:"/js/plugins/fcircle.js",weibo:"/js/plugins/weibo.js",memos:"/js/plugins/memos.js",marked:"/js/plugins/marked.js"}),stellar.plugins.marked=Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js"),stellar.plugins.lazyload=Object.assign({enable:!0,js:"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js",transition:"blur"}),stellar.plugins.swiper=Object.assign({enable:!0,css:"https://unpkg.com/swiper@10.3/swiper-bundle.min.css",js:"https://unpkg.com/swiper@10.3/swiper-bundle.min.js"}),stellar.plugins.preload=Object.assign({enable:!0,service:"flying_pages",instant_page:"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js",flying_pages:"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"}),stellar.plugins.fancybox=Object.assign({enable:!0,js:"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js",css:"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css",selector:".fancybox img"}),stellar.plugins.copycode=Object.assign({enable:!0,js:"/js/plugins/copycode.js",default_text:"Copy",success_text:"Copied",toast:"复制成功"})</script><script src="/js/main.js" async></script><script>function loadJS(){const e=document.querySelectorAll("#comments #giscus");0!==e.length&&e.forEach((e,t)=>{try{e.innerHTML=""}catch(e){console.error(e)}var n=document.createElement("script");n.async=!0;for(let t of Object.keys(e.attributes)){let c=e.attributes[t];!1===["class","id"].includes(c.name)&&n.setAttribute(c.name,c.value)}e.appendChild(n)})}window.addEventListener("DOMContentLoaded",e=>{loadJS()})</script></div></body></html>